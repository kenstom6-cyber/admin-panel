<script>
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const btn = document.getElementById('loginBtn');
        const btnText = document.getElementById('btnText');
        const loading = document.getElementById('loading');
        const debugInfo = document.getElementById('debugInfo');
        
        // Show loading
        btn.disabled = true;
        btnText.textContent = 'Đang đăng nhập...';
        loading.classList.remove('hidden');
        
        // Clear debug
        debugInfo.innerHTML = '';
        debugInfo.classList.remove('hidden');
        
        try {
            console.log('=== LOGIN ATTEMPT ===');
            console.log('Username:', username);
            
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                credentials: 'include', // QUAN TRỌNG
                body: JSON.stringify({ username, password })
            });
            
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            const data = await response.json();
            console.log('Response data:', data);
            
            // Show debug info
            debugInfo.innerHTML = `
                <strong>Debug Info:</strong><br>
                Status: ${response.status}<br>
                Success: ${data.success}<br>
                Session ID: ${data.sessionId || 'none'}<br>
                User: ${data.user ? data.user.username : 'none'}
            `;
            
            if (data.success) {
                debugInfo.innerHTML += '<br><span class="text-green-600">✓ Server login successful!</span>';
                
                // ĐỢI 2 GIÂY rồi kiểm tra session
                setTimeout(async () => {
                    try {
                        console.log('Checking session status...');
                        
                        const statusRes = await fetch('/api/auth/status', {
                            credentials: 'include'
                        });
                        
                        console.log('Status response:', statusRes.status);
                        const statusData = await statusRes.json();
                        console.log('Status data:', statusData);
                        
                        debugInfo.innerHTML += `<br>Session check: ${statusData.authenticated ? 'Authenticated ✓' : 'Not authenticated ✗'}`;
                        
                        if (statusData.authenticated) {
                            debugInfo.innerHTML += '<br><span class="text-green-600">✓ Redirecting to dashboard...</span>';
                            
                            // Chuyển hướng TRỰC TIẾP không qua kiểm tra
                            window.location.href = '/dashboard';
                            
                        } else {
                            // Thử debug cookies
                            const cookieRes = await fetch('/api/debug/cookies', {
                                credentials: 'include'
                            });
                            const cookieData = await cookieRes.json();
                            console.log('Cookie debug:', cookieData);
                            
                            debugInfo.innerHTML += `<br><span class="text-red-600">✗ Session không tồn tại</span>`;
                            debugInfo.innerHTML += `<br>Cookies: ${cookieData.cookies}`;
                            
                            alert('❌ Session không được lưu. Thử đặt cookie thủ công?');
                            resetButton();
                        }
                        
                    } catch (err) {
                        console.error('Session check error:', err);
                        // Vẫn thử redirect
                        window.location.href = '/dashboard';
                    }
                }, 2000);
                
            } else {
                alert('❌ ' + (data.error || 'Đăng nhập thất bại'));
                resetButton();
            }
            
        } catch (error) {
            console.error('Login error:', error);
            debugInfo.innerHTML = `<strong>Error:</strong><br>${error.message}`;
            alert('❌ Lỗi kết nối: ' + error.message);
            resetButton();
        }
        
        function resetButton() {
            btn.disabled = false;
            btnText.textContent = 'Đăng Nhập';
            loading.classList.add('hidden');
        }
    });
    
    // Test session trước khi đăng nhập
    window.addEventListener('load', async () => {
        try {
            const res = await fetch('/api/debug/cookies', {
                credentials: 'include'
            });
            const data = await res.json();
            console.log('Initial cookies:', data.cookies);
        } catch (err) {
            console.log('Cannot get initial cookies:', err.message);
        }
    });
</script>
